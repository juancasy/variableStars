---
title: "Experiments"
author: "Roberto Maestre"
date: "10/24/2018"
output: github_document
---

```{r setup, include=FALSE}
library(variableStars)
library(data.table)
library(ggplot2)
library(microbenchmark)
```


## Experiment configuration

#### Parameters for execution

```{r parameters}
paramters = list(
  "filter" = "gaussian",
  "gRegimen" = 0,
  "minDnu" = 15,
  "maxDnu" = 95,
  "dnuValue" = -1,
  "dnuGuessError" = 10,
  "dnuEstimation" = TRUE,
  "numFrequencies" = 30,
  "debug" = TRUE)
```

#### Data source

Choose: 

 * dataFlag = T, to use synthetic data generated or,

 * dataFlag = F, to use a real pulsar photometry

```{r flag}
dataFlag = T
```

## Data generation


```{r dataGeneration}
# Generate synthetic data or read pulsar data
if (dataFlag) {
  x <- sin(seq(from = 0,
               to = 100,
               by = 1))
  dt <-
    data.frame("time" = seq(from = 1, to = length(x)), "mmag" = x)
} else {
  # Read pulsar data
  dt <- data.table(read.csv("../data/pulsar.tsv", sep = "\t"))
}

# Sampling for large file
dt.plot <- dt
if(dim(dt)[1]>1000) {
  dt.plot <- dt[sample(nrow(dt), 1000),]
}
# Plot photometry
ggplot(aes(time, mmag), data = dt.plot) +
    geom_point() +
    geom_line() +
    theme_bw()
rm(dt.plot) # Drop memory
```

#### Frequences and Amplitudes on photometry data

```{r calculateEspectrum, warning=F}
# Calculate amplitudes and frequences
dt.spectrum <- data.frame(calculateSpectrum(dt$time, dt$mmag))
# Get max amplitude
maxAmplitude <- dt.spectrum[which.max(dt.spectrum$amplitude), ]
# Plot amplitudes
plot_spectrum(maxAmplitude$frequency - 1.5,
              maxAmplitude$frequency + 1.5,
              dt.spectrum)
# Save Data to disk (to be replicated)
write.table(
  dt.spectrum[c("frequency", "amplitude")],
  file = "/tmp/data.csv",
  sep = "\t",
  quote = F,
  row.names = F,
  col.names = F
)
```

##  Experiment execution

process is the main method on the variableStars package to compute and estimate all parameters

```{r calculate, warning=F}
result <- process(
  dt.spectrum$frequency,
  dt.spectrum$amplitude,
  filter = paramters$filter,
  gRegimen = paramters$gRegimen,
  minDnu = paramters$minDnu,
  maxDnu = paramters$maxDnu,
  dnuValue = paramters$dnuValue,
  dnuGuessError = paramters$dnuGuessError,
  dnuEstimation = paramters$dnuEstimation,
  numFrequencies = paramters$numFrequencies,
  debug = paramters$debug
)
```

#### Main results

* **Dnu** (```result$dnu```) = `r result$dnu`.
* **DnuGuess** ```(result$dnuGuess```) = `r result$dnuGuess`.
* **DnuPeak** (```result$dnuPeak```) = `r result$dnuPeak`.
* **Frequency** (```result$photometry$frequency```) = `r head(c(result$photometry$frequency), 25)`...
* **Amplitude** (```result$photometry$amplitude```) = `r head(c(result$photometry$amplitude), 25)`...
* **Diffs** (```result$diffHistogram$diffs```) = `r head(c(result$diffHistogram$diffs), 25)`...

#### Apodization


```{r apodization, warning=F}
# Plot frecuency and amplitude
ggplot(
  aes(x = frequences, y = amplitude),
  data = data.frame(
    "frequences" = result$ft$frequences,
    "amplitude" = result$ft$amp
  )
) +
  geom_point() +
  geom_line() +
  ggtitle("Apodization- Frequences and amplitudes") +
  theme_bw()
```

#### FT - Power Spectrum

```{r ftPower, warning=F}
# Plot frecuency and amplitude
dt <-
  data.frame("f" = result$ft$f,
             "powerSpectrum" = result$ft$powerSpectrum)
ggplot(aes(x = f, y = powerSpectrum), data = dt) +
  geom_point() +
  geom_line() +
  ggtitle("FT - Power Spectrum") +
  theme_bw()
```

####  Histogram fo differences. 

We only show bins with >0 values


```{r diffsHistogram, warning=F}
dt <- data.frame(result$diffHistogram$histogram)
ggplot(aes(x = bins, y = values), data = dt[dt$values > 0,]) +
  geom_bar(stat = "identity") +
  ggtitle("Histogram of differences") +
  theme_bw()
```


